<script>
  // Variables para almacenar el último punto con check-in
  let ultimoCheckInLatLng = null;

  async function cargarPuntos() {
    const url = `https://api.airtable.com/v0/${baseId}/${tableName}`;
    const headers = {
      Authorization: `Bearer ${airtableToken}`,
    };

    try {
      const res = await fetch(url, { headers });
      const data = await res.json();

      data.records.forEach(record => {
        const nombre = record.fields.Nombre || 'Sin nombre';
        const direccion = record.fields.Direccion || 'Sin dirección';
        const lat = record.fields.Latitud;
        const lng = record.fields.Longitud;
        let check = record.fields.CheckIn || false;
        const persona = record.fields.Persona || 'Sin persona';

        if (lat && lng) {
          if (check) {
            ultimoCheckInLatLng = [lat, lng]; // Guardamos el último punto con check-in
          }

          const icon = L.circleMarker([lat, lng], {
            radius: 12,
            color: check ? 'green' : 'gray',
            fillColor: check ? 'green' : '#888',
            fillOpacity: check ? 0.7 : 0.3,
            weight: 3,
            opacity: 1
          });

          const popupContent = `
            <b>${nombre}</b><br>
            ${direccion}<br>
            <b>Check-in:</b> ${check ? 'Sí' : 'No'}<br>
            <b>Persona:</b> ${persona}<br>
            <button class="delete-btn" onclick="eliminarPunto('${record.id}', this)">Eliminar</button>
          `;

          icon.bindPopup(popupContent);
          icon.addTo(map);

          // Mostrar info al pasar por encima
          icon.on('mouseover', () => {
            icon.openPopup();
          });
          icon.on('mouseout', () => {
            icon.closePopup();
          });

          // Clic para alternar CheckIn (igual que antes)
          icon.on('click', async () => {
            if (!check) {
              const personaInput = prompt("Ingresa tu nombre para el check-in:");
              if (personaInput) {
                check = true;
                icon.setStyle({ fillColor: 'green', fillOpacity: 0.7, color: 'green' });
                icon.setPopupContent(popupContent);
                icon.openPopup();

                await fetch(`${url}/${record.id}`, {
                  method: 'PATCH',
                  headers: {
                    'Authorization': `Bearer ${airtableToken}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    fields: { CheckIn: check, Persona: personaInput }
                  })
                });

                location.reload();
              }
            } else {
              if (confirm("¿Seguro que quieres eliminar el check-in?")) {
                check = false;
                icon.setStyle({ fillColor: '#888', fillOpacity: 0.3, color: 'gray' });
                icon.setPopupContent(popupContent);
                icon.openPopup();

                await fetch(`${url}/${record.id}`, {
                  method: 'PATCH',
                  headers: {
                    'Authorization': `Bearer ${airtableToken}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    fields: { CheckIn: false, Persona: '' }
                  })
                });

                location.reload();
              }
            }
          });
        }
      });

      // Al terminar de cargar puntos, enfocar al último con check-in si existe
      if (ultimoCheckInLatLng) {
        map.setView(ultimoCheckInLatLng, 16); // Zoom directo
      }

    } catch (error) {
      console.error("Error al cargar desde Airtable:", error);
    }
  }
</script>
